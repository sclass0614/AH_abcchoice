<div class="class-select-page">
  <h1>우리집 일상선택</h1>

  <div class="member-info" id="member-info">
    <div class="member-info-text">
      <div class="member-name" id="member-name">-</div>
      <div class="member-details" id="member-details">
        회원번호: -, 생년월일: -
      </div>
      <div class="button-container">
        <button class="change-member-btn" id="change-member-btn">
          회원 변경
        </button>
        <button class="change-member-btn" id="reset-btn">초기화</button>
      </div>
    </div>
    <!-- 신청한 클래스 표시 영역 -->
    <div class="applied-classes">
      <div class="applied-classes-title">신청 목록:</div>
      <div class="applied-class-tags" id="applied-class-tags">
        <span class="empty-applied">아직 신청한 클래스가 없습니다.</span>
        <!-- 신청한 클래스 태그가 여기에 추가됩니다 -->
      </div>
    </div>
    <div class="date-selector">
      <span class="date-label">조회날짜:</span>
      <input type="date" id="date-input" class="date-input" />
    </div>
  </div>

  <!-- 필터 버튼 추가 -->
  <div class="filter-container">
    <button class="filter-button" data-filter="all">전체 클래스</button>
    <button class="filter-button active" data-filter="class1">1차 클래스</button>
    <button class="filter-button" data-filter="class2">2차 클래스</button>
    <button class="filter-button" data-filter="class3">3차 클래스</button>
    <button class="filter-button" data-filter="class4">4차 클래스</button>
    <button class="filter-button" data-filter="class5">5차 클래스</button>
  </div>

  <div class="products-container" id="products-container">
    <!-- 활동 카드는 스크립트에서 동적으로 생성됩니다 -->
  </div>

  <!-- 확인 모달 -->
  <div id="confirm-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">신청 확인</h2>
        <span class="modal-close" id="modal-close">&times;</span>
      </div>
      <div class="modal-body">
        <div class="modal-info">
          <p><strong>회원:</strong> <span id="confirm-member-name">-</span></p>
          <p>
            <strong>활동:</strong> <span id="confirm-activity-name">-</span>
          </p>
          <p><strong>시간:</strong> <span id="confirm-time">-</span></p>
          <p><strong>직원명:</strong> <span id="confirm-instructor">-</span></p>
        </div>
        <p>위 활동을 신청하시겠습니까?</p>
        <div class="modal-buttons">
          <button id="apply-button" class="apply-button">신청하기</button>
          <button id="cancel-button" class="cancel-button">취소</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 로딩 표시 -->
  <div id="loading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>데이터 로딩 중...</p>
  </div>

  <!-- 성공 메시지 -->
  <div id="success-message" class="success-message">신청이 완료되었습니다!</div>

  <!-- 모든 클래스 완료 확인 모달 - 완전히 새로운 스타일 -->
  <div id="complete-modal-overlay" class="complete-modal-overlay">
    <div id="complete-modal-container" class="complete-modal-container">
      <div id="complete-modal-header" class="complete-modal-header">
        <h2 id="complete-modal-title" class="complete-modal-title">
          신청 내역 확인
        </h2>
        <div id="complete-modal-subtitle" class="complete-modal-subtitle">
          활동 신청을 완료하시겠습니까?
        </div>
        <div id="complete-modal-close" class="complete-modal-close">
          <span>&times;</span>
        </div>
      </div>
      <div id="complete-modal-body" class="complete-modal-body">
        <p id="complete-modal-message" class="complete-modal-message">
          모든 활동 신청이 완료되었습니다. 아래 신청 내역을 확인해주세요.
        </p>
        <div id="complete-classes-list" class="complete-classes-list">
          <!-- 신청한 클래스 항목이 여기에 추가됩니다 -->
        </div>
        <div id="complete-modal-actions" class="complete-modal-actions">
          <button
            id="complete-modal-btn-primary"
            class="complete-modal-btn complete-modal-btn-primary"
          >
            신청 완료
          </button>
          <button
            id="complete-modal-btn-secondary"
            class="complete-modal-btn complete-modal-btn-secondary"
          >
            계속 선택하기
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // 전역 변수들
  let selectedMember = null;
  let selectedActivity = null;
  let appliedClasses = []; // 신청한 클래스 배열
  let selectedDate = new Date(); // 선택된 날짜

  // 시간대 관리를 위한 전역 설정
  const CLASS_TIMES = {
    // 동적으로 업데이트될 데이터
    START: [],
    END: [],
    LABELS: [],
    TITLES: [],

    // 특정 시간이 어느 차수에 속하는지 확인
    getClassIndex: function (time) {
      const timeNum = parseInt(time);
      for (let i = 0; i < this.START.length; i++) {
        if (timeNum >= this.START[i] && timeNum < this.END[i]) {
          return i;
        }
      }
      return -1; // 해당 없음
    },

    // 차수 번호로 레이블 가져오기 (0부터 시작)
    getLabel: function (index) {
      return index >= 0 && index < this.LABELS.length
        ? this.LABELS[index]
        : "기타";
    },

    // 시간으로 레이블 가져오기
    getLabelByTime: function (time) {
      const index = this.getClassIndex(time);
      return this.getLabel(index);
    },

    // 시간 형식 변환 (HHMM -> HH:MM)
    formatTime: function (time) {
      if (!time) return "";
      const timeStr = time.toString().padStart(4, "0");
      return `${timeStr.substring(0, 2)}:${timeStr.substring(2, 4)}`;
    },

    // 시간대 타이틀 동적 업데이트
    updateTitles: function () {
      this.TITLES = []; // 타이틀 초기화
      for (let i = 0; i < this.LABELS.length; i++) {
        const formattedStart = this.formatTime(this.START[i]);
        const formattedEnd = this.formatTime(this.END[i]);
        this.TITLES.push(
          `${this.LABELS[i]} 클래스 (${formattedStart} - ${formattedEnd})`
        );
      }
      return this.TITLES;
    },

    // 실제 데이터에서 시간 정보 업데이트
    updateFromData: function (data) {
      if (!data || !Array.isArray(data) || data.length === 0) {
        console.warn("시간 정보를 업데이트할 데이터가 없음");
        return false;
      }

      // 데이터에서 고유한 시작 시간과 종료 시간 쌍 추출
      const uniqueTimes = new Map();

      data.forEach((row) => {
        if (row && row.시작시간 && row.종료시간) {
          // 시작 시간과 종료 시간이 있는 경우
          const startTime = parseInt(String(row.시작시간));
          const endTime = parseInt(String(row.종료시간));

          if (!isNaN(startTime) && !isNaN(endTime)) {
            const key = `${startTime}-${endTime}`;
            if (!uniqueTimes.has(key)) {
              uniqueTimes.set(key, { start: startTime, end: endTime });
            }
          }
        }
      });

      // 시작 시간 순으로 정렬
      const sortedTimes = Array.from(uniqueTimes.values()).sort(
        (a, b) => a.start - b.start
      );

      // 데이터 업데이트
      if (sortedTimes.length === 0) {
        console.warn("추출된 시간 정보가 없음");
        return false;
      }

      console.log("데이터에서 추출한 시간 정보:", sortedTimes);

      // 최대 5개 차수만 사용
      const maxClasses = Math.min(sortedTimes.length, 5);

      // 새 시간 정보로 업데이트
      this.START = [];
      this.END = [];
      this.LABELS = [];

      for (let i = 0; i < maxClasses; i++) {
        this.START.push(sortedTimes[i].start);
        this.END.push(sortedTimes[i].end);
        this.LABELS.push(`${i + 1}차`);
      }

      // 타이틀 업데이트
      this.updateTitles();
      return true;
    },
  };

  // 클래스 선택 페이지 초기화 함수
  window.initializeClassSelect = function () {
    console.log("initializeClassSelect 함수 호출됨");

    // 전역 상태 확인
    console.log("전역 상태:", window.appState);

    // 디버깅: 전역 데이터 검사
    console.log("[DEBUG] window.totalData 확인:", window.totalData);
    if (window.totalData) {
      console.log(
        "[DEBUG] memberData 길이:",
        window.totalData.memberData
          ? window.totalData.memberData.length
          : "없음"
      );
      console.log(
        "[DEBUG] classData 길이:",
        window.totalData.classData ? window.totalData.classData.length : "없음"
      );
      console.log(
        "[DEBUG] planData 길이:",
        window.totalData.planData ? window.totalData.planData.length : "없음"
      );

      // 데이터 샘플 확인
      if (window.totalData.planData && window.totalData.planData.length > 0) {
        console.log(
          "[DEBUG] planData 첫 번째 항목 샘플:",
          window.totalData.planData[0]
        );
      }
    } else {
      console.warn("[DEBUG] window.totalData가 정의되지 않음");
    }

    // 전역 상태에서 선택된 회원 정보 가져오기
    try {
      selectedMember = window.appState.selectedMember;
      console.log("가져온 회원 정보:", selectedMember);
    } catch (error) {
      console.error("회원 정보 가져오기 오류:", error);
    }

    if (!selectedMember) {
      console.warn("선택된 회원 정보 없음");
      // 선택된 회원이 없으면 회원 선택 페이지로 이동
      alert("선택된 회원이 없습니다. 회원을 먼저 선택해주세요.");
      loadPage("member-select");
      return;
    }

    // 신청한 클래스 배열 초기화
    appliedClasses = window.appState.appliedClasses || [];

    // 선택된 날짜 설정
    selectedDate = window.appState.selectedDate || new Date();

    // 회원 정보 표시
    displayMemberInfo();

    // 신청한 클래스 정보 표시
    displayAppliedClasses();

    // 날짜 입력 필드 초기화
    initDateInput();

    // 활동 데이터 로드
    loadPlanData();

    // 필터 버튼 이벤트 리스너 추가
    setupFilterButtons();

    // 모달 버튼 초기화
    setupModalButtons();

    // 회원 변경 버튼 클릭 이벤트 리스너 추가
    const changeMemberBtn = document.getElementById("change-member-btn");
    if (changeMemberBtn) {
      changeMemberBtn.addEventListener("click", changeMember);
    }

    // 초기화 버튼 클릭 이벤트 리스너 추가
    const resetBtn = document.getElementById("reset-btn");
    if (resetBtn) {
      resetBtn.addEventListener("click", resetAllClasses);
    }

    // 모달 관련 이벤트 리스너 추가

    // 모달 닫기 버튼 이벤트 리스너 추가
    const modalCloseBtn = document.getElementById("modal-close");
    if (modalCloseBtn) {
      modalCloseBtn.addEventListener("click", closeModal);
    }

    // 신청 취소 버튼 이벤트 리스너 추가
    const cancelBtn = document.getElementById("cancel-button");
    if (cancelBtn) {
      cancelBtn.addEventListener("click", closeModal);
    }

    // 신청하기 버튼 이벤트 리스너 추가
    const applyBtn = document.getElementById("apply-button");
    if (applyBtn) {
      applyBtn.addEventListener("click", applyActivity);
    }

    // 최종 모달 닫기 버튼 이벤트 리스너 추가
    const finalModalCloseBtn = document.getElementById("final-modal-close");
    if (finalModalCloseBtn) {
      finalModalCloseBtn.addEventListener("click", function () {
        document
          .getElementById("final-confirm-modal")
          .classList.remove("active");
      });
    }

    // 최종 취소 버튼 이벤트 리스너 추가
    const finalCancelBtn = document.querySelector(".final-confirm-btn.cancel");
    if (finalCancelBtn) {
      finalCancelBtn.addEventListener("click", function () {
        document
          .getElementById("final-confirm-modal")
          .classList.remove("active");
      });
    }

    // 최종 신청 버튼 이벤트 리스너 추가
    const finalSubmitBtn = document.querySelector(".final-confirm-btn.submit");
    if (finalSubmitBtn) {
      finalSubmitBtn.addEventListener("click", function () {
        alert("최종 신청이 완료되었습니다!");
        document
          .getElementById("final-confirm-modal")
          .classList.remove("active");
      });
    }

    // 모든 클래스 완료 모달 닫기 버튼 이벤트 리스너 추가
    const completeModalCloseBtn = document.getElementById(
      "complete-modal-close"
    );
    if (completeModalCloseBtn) {
      completeModalCloseBtn.addEventListener("click", closeCompleteModal);
    }

    // 모든 클래스 완료 모달 계속 선택하기 버튼 이벤트 리스너 추가
    const completeModalSecondaryBtn = document.getElementById(
      "complete-modal-btn-secondary"
    );
    if (completeModalSecondaryBtn) {
      completeModalSecondaryBtn.addEventListener("click", closeCompleteModal);
    }
  };

  // 페이지 로드 시 실행
  document.addEventListener("DOMContentLoaded", function () {
    initializeClassSelect();
  });

  // ESC 키 이벤트 리스너 추가
  document.addEventListener("keydown", function (event) {
    // ESC 키 (keyCode 27)가 눌렸을 때
    if (event.key === "Escape" || event.keyCode === 27) {
      // 활성화된 카드가 있는지 확인
      const activeCard = document.querySelector(".product-card.active");
      if (activeCard) {
        // 카드 초기화 함수 호출
        resetAllCards();
      }
    }
  });

  // 날짜 입력 필드 초기화
  function initDateInput() {
    const dateInput = document.getElementById("date-input");
    if (!dateInput) return;

    // 선택된 날짜가 있으면 사용
    if (selectedDate) {
      const formattedDate = formatDate(selectedDate);
      dateInput.value = formattedDate;
    } else {
      // 오늘 날짜로 초기화
      const today = new Date();
      const formattedDate = formatDate(today);
      dateInput.value = formattedDate;
      selectedDate = today;

      // 전역 상태 업데이트
      window.updateState("selectedDate", today);
    }

    // 날짜 입력 필드 클릭 시 회원 선택 페이지로 이동
    dateInput.addEventListener("click", function (event) {
      // 기본 동작 방지 (달력 표시 방지)
      event.preventDefault();

      // 페이드 아웃 효과 적용 후 페이지 이동
      const pageContainer = document.querySelector(".class-select-page");
      if (pageContainer) {
        pageContainer.classList.add("p1-fade-out");
        setTimeout(() => {
          // 회원 선택 페이지로 이동
          loadPage("member-select");
        }, 400);
      }
    });

    // readonly 속성 추가하여 직접 입력 방지
    dateInput.setAttribute("readonly", "readonly");
  }

  // 날짜 변경 처리
  function handleDateChange(event) {
    const newDate = new Date(event.target.value);
    selectedDate = newDate;

    // 전역 상태 업데이트
    window.updateState("selectedDate", newDate);

    // 날짜 변경 시 활동 데이터 다시 로드
    console.log("날짜 변경됨, 계획 데이터 다시 로드");
    loadPlanData();
  }

  // 날짜 포맷 함수 (yyyy-mm-dd)
  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  }

  // 회원 정보 표시
  function displayMemberInfo() {
    console.log(
      "displayMemberInfo 함수 호출됨, selectedMember:",
      selectedMember
    );

    if (!selectedMember) {
      console.warn("displayMemberInfo: 회원 정보 없음");
      return;
    }

    try {
      // 생년월일 포맷팅 (YYYYMMDD → YYYY-MM-DD)
      let birthDate = "정보 없음";

      if (selectedMember.birth) {
        // 숫자나 문자열 모두 문자열로 변환 후 처리
        const birthStr = String(selectedMember.birth);
        if (birthStr.length === 8) {
          birthDate = `${birthStr.substring(0, 4)}-${birthStr.substring(
            4,
            6
          )}-${birthStr.substring(6, 8)}`;
        }
      }

      console.log("포맷된 생년월일:", birthDate);
      console.log("표시할 회원 이름:", selectedMember.name);
      console.log("표시할 회원 번호:", selectedMember.number);

      // 회원 정보 업데이트
      const nameElement = document.getElementById("member-name");
      const detailsElement = document.getElementById("member-details");

      if (nameElement && detailsElement) {
        nameElement.innerHTML = `${selectedMember.name} <span class="greeting">어르신 즐거운하루되세요</span>`;
        detailsElement.innerHTML = `
                <div class="member-number">회원번호: ${selectedMember.number}</div>
                <div class="member-birth">생년월일: ${birthDate}</div>
            `;
        console.log("회원 정보 DOM 업데이트 완료");
      } else {
        console.error("회원 정보 DOM 요소 찾을 수 없음:", {
          nameElement: !!nameElement,
          detailsElement: !!detailsElement,
        });
      }
    } catch (error) {
      console.error("회원 정보 표시 중 오류 발생:", error);
    }
  }

  // 신청한 클래스 정보 표시
  function displayAppliedClasses() {
    const appliedClassesContainer =
      document.getElementById("applied-class-tags");
    if (!appliedClassesContainer) return;

    // 컨테이너 초기화
    appliedClassesContainer.innerHTML = "";

    if (appliedClasses.length === 0) {
      // 신청한 클래스가 없는 경우
      appliedClassesContainer.innerHTML =
        '<span class="empty-applied">아직 신청한 클래스가 없습니다.</span>';
      return;
    }

    // 신청한 각 클래스에 대해 태그 생성
    appliedClasses.forEach((activity, index) => {
      const tag = document.createElement("div");
      tag.className = "applied-class-tag";

      const time = document.createElement("span");
      time.className = "applied-class-tag-time";
      time.textContent = `${activity.startTime.substring(
        0,
        2
      )}:${activity.startTime.substring(2, 4)}`;

      const title = document.createElement("span");
      title.className = "applied-class-tag-title";
      title.textContent = activity.title;

      const deleteBtn = document.createElement("span");
      deleteBtn.className = "applied-class-tag-delete";
      deleteBtn.textContent = "×";
      deleteBtn.addEventListener("click", function () {
        deleteAppliedClass(index);
      });

      tag.appendChild(time);
      tag.appendChild(title);
      tag.appendChild(deleteBtn);

      appliedClassesContainer.appendChild(tag);
    });

    // 전역 상태 업데이트
    window.updateState("appliedClasses", appliedClasses);
  }

  // 신청한 클래스 삭제
  function deleteAppliedClass(index) {
    // 해당 인덱스의 클래스 삭제
    appliedClasses.splice(index, 1);

    // UI 업데이트
    displayAppliedClasses();

    // 전역 상태 업데이트
    window.updateState("appliedClasses", appliedClasses);
  }

  // 시간대별 섹션 표시
  function displayTimeSection(title, activities) {
    const container = document.getElementById("products-container");
    if (!container) return;

    // 활동이 없으면 해당 섹션을 표시하지 않음
    if (!activities || activities.length === 0) {
      return;
    }

    // 시간대별 클래스 ID 추출 (1차, 2차, 3차...)
    const classNum = title.charAt(0);

    // 시간대 섹션 컨테이너 생성
    const sectionContainer = document.createElement("div");
    sectionContainer.className = "time-section";
    sectionContainer.id = `class${classNum}-section`;

    // 섹션 타이틀 생성
    const sectionTitle = document.createElement("h2");
    sectionTitle.className = "time-section-title";
    sectionTitle.id = `time-title-${classNum}`;
    sectionTitle.textContent = title;

    // 카드 컨테이너 생성
    const cardsContainer = document.createElement("div");
    cardsContainer.className = "cards-container";
    cardsContainer.id = `cards-container-${classNum}`;

    // 시간대 섹션에 타이틀 추가
    sectionContainer.appendChild(sectionTitle);

    // 시간대 섹션에 카드 컨테이너 추가
    sectionContainer.appendChild(cardsContainer);

    // 활동 카드 추가
    updateProductCards(activities, cardsContainer);

    // 메인 컨테이너에 시간대 섹션 추가
    container.appendChild(sectionContainer);
  }

  // 활동 카드 업데이트 함수
  function updateProductCards(activities, targetContainer = null) {
    const container =
      targetContainer || document.getElementById("products-container");
    if (!container) return;

    // 컨테이너가 직접 지정되지 않았고 기존 컨테이너를 사용하는 경우에만 비움
    if (!targetContainer) {
      container.innerHTML = "";
    }

    // 활동명(title) 기준으로 오름차순 정렬
    const sortedActivities = [...activities].sort((a, b) => {
      const titleA = a.활동명 || "제목 없음";
      const titleB = b.활동명 || "제목 없음";
      return titleA.localeCompare(titleB);
    });

    // 활동별로 카드 생성
    sortedActivities.forEach((activity) => {
      let id,
        title,
        startTime,
        endTime,
        instructor,
        lifeArea,
        location,
        imageUrl,
        description;

      // 객체 데이터 처리
      id = activity.계획_id || "";
      startTime = activity.시작시간 ? String(activity.시작시간) : "";
      endTime = activity.종료시간 ? String(activity.종료시간) : "";
      const employeeNumber = activity.직원번호 || ""; // 직원번호 추가
      instructor = activity.직원명 || "정보 없음";
      title = activity.활동명 || "제목 없음";
      lifeArea = activity.생활영역 || "";
      location = activity.장소 || "정보 없음";
      description = activity.내용및특이사항 || "내용 정보가 없습니다";
      imageUrl = activity.참고사진url || "https://i.ibb.co/qM8hjSxt/4-3.jpg";

      // 시간 포맷팅 (HHMM → HH:MM)
      const formattedStartTime = startTime
        ? `${startTime.substring(0, 2)}:${startTime.substring(2, 4)}`
        : "";
      const formattedEndTime = endTime
        ? `${endTime.substring(0, 2)}:${endTime.substring(2, 4)}`
        : "";

      // lifeArea 처리 - '-' 기준으로 분할하고 index 1의 값만 사용
      let displayLifeArea = "";
      if (lifeArea && lifeArea.includes("-")) {
        const lifeAreaParts = lifeArea.split("-");
        if (lifeAreaParts.length > 1) {
          displayLifeArea = lifeAreaParts[1].trim();
        } else {
          displayLifeArea = lifeArea;
        }
      } else {
        displayLifeArea = lifeArea;
      }

      // 카드 ID 생성
      const cardId = `card-${id}`;

      // 랜덤 파스텔 색상 클래스 생성 (1-8 사이의 랜덤 숫자)
      const colorIndex = Math.floor(Math.random() * 8) + 1;
      const colorClass = `pastel-color-${colorIndex}`;

      // HTML로 카드 생성
      const cardHtml = `
                    <div id="${cardId}" class="product-card ${colorClass}" 
                        data-id="${id}" 
                        data-title="${title}" 
                        data-start="${startTime}" 
                        data-end="${endTime}" 
                        data-instructor="${instructor}"
                        data-employee-number="${employeeNumber}" 
                        data-life-area="${lifeArea}"
                        data-location="${location}"
                        data-background="${imageUrl}">
                    <div class="card-front">
                        ${
                          displayLifeArea
                            ? `<div class="ribbon">${displayLifeArea}</div>`
                            : ""
                        }
                        <div class="product-info">
                            <div class="product-title">${title}</div>
                            <div class="product-details">
                                <div class="product-instructor">담당: ${instructor}</div>
                                <div class="product-location">장소: ${location}</div>
                            </div>
                            <div class="product-description">${description}</div>
                        </div>
                    </div>
                        <div class="card-back" style="background-image: url('${imageUrl}')">
                            <div>
                        <h3>${title}</h3>
                            </div>
                            <button class="apply-class-btn" id="apply-btn-${id}">신청하기</button>
                        </div>
                    </div>
                `;

      // HTML 추가
      container.insertAdjacentHTML("beforeend", cardHtml);

      // 방금 추가한 카드 찾기
      const card = container.lastElementChild;

      // 카드 클릭 이벤트 추가
      card.addEventListener("click", handleCardClick);

      // 신청 버튼 클릭 이벤트 추가
      const applyBtn = card.querySelector(".apply-class-btn");
      if (applyBtn) {
        applyBtn.addEventListener("click", function (event) {
          event.stopPropagation(); // 버블링 방지
          openConfirmModal(card);
        });
      }
    });
  }

  // 카드 클릭 이벤트 핸들러
  function handleCardClick(event) {
    // 버튼 클릭 시 카드 클릭 이벤트 무시
    if (event.target.tagName === "BUTTON") return;

    // 현재 클릭한 카드
    const clickedCard = this;

    // 현재 클릭한 카드가 이미 활성화 상태인지 확인
    const isClickedCardActive = clickedCard.classList.contains("active");

    // 활성화된 모든 카드 찾기
    const allCards = document.querySelectorAll(".product-card");
    const activeCard = document.querySelector(".product-card.active");

    // 오버레이 가져오기 또는 생성
    let overlay = document.querySelector(".card-overlay");
    if (!overlay) {
      overlay = document.createElement("div");
      overlay.className = "card-overlay";
      document.body.appendChild(overlay);

      // 오버레이 클릭 이벤트 리스너 추가
      overlay.addEventListener("click", function () {
        // 활성화된 카드 찾아서 비활성화
        const activeCard = document.querySelector(".product-card.active");
        if (activeCard) {
          activeCard.classList.remove("active");

          // 모든 카드의 inactive 클래스 제거
          document.querySelectorAll(".product-card").forEach((card) => {
            card.classList.remove("inactive");
          });

          // 오버레이 비활성화
          overlay.classList.remove("active");
        }
      });
    }

    // 화면 너비 확인 (768px 이상인 경우에만 중앙 배치 효과 적용)
    const isDesktop = window.innerWidth > 768;

    // 1. 현재 활성화된 카드가 있고, 클릭한 카드가 활성화된 카드가 아니라면
    if (activeCard && activeCard !== clickedCard) {
      // 기존 활성화 카드 비활성화
      activeCard.classList.remove("active");

      // 모든 카드의 inactive 클래스 제거
      allCards.forEach((card) => {
        card.classList.remove("inactive");
      });

      // 클릭한 카드를 제외한 다른 모든 카드를 inactive로 설정
      allCards.forEach((card) => {
        if (card !== clickedCard) {
          card.classList.add("inactive");
        }
      });

      // 크기에 따라 카드 활성화 방식 변경
      if (isDesktop) {
        requestAnimationFrame(() => {
          clickedCard.classList.add("active");
          overlay.classList.add("active");
        });
      } else {
        requestAnimationFrame(() => {
          clickedCard.classList.add("active");
        });
      }
    }
    // 2. 클릭한 카드가 이미 활성화된 상태라면
    else if (isClickedCardActive) {
      // 클릭한 카드 비활성화
      clickedCard.classList.remove("active");

      // 모든 카드의 inactive 클래스 제거
      allCards.forEach((card) => {
        card.classList.remove("inactive");
      });

      // 오버레이 비활성화
      overlay.classList.remove("active");
    }
    // 3. 활성화된 카드가 없고, 클릭한 카드가 활성화되지 않은 상태라면
    else {
      // 클릭한 카드를 제외한 다른 모든 카드를 inactive로 설정
      allCards.forEach((card) => {
        if (card !== clickedCard) {
          card.classList.add("inactive");
        }
      });

      // 크기에 따라 카드 활성화 방식 변경
      if (isDesktop) {
        requestAnimationFrame(() => {
          clickedCard.classList.add("active");
          overlay.classList.add("active");
        });
      } else {
        requestAnimationFrame(() => {
          clickedCard.classList.add("active");
        });
      }
    }
  }

  // 모바일 환경에서 카드 외부 클릭 이벤트 추가
  document.addEventListener("click", function (event) {
    // 활성화된 카드가 있는지 확인
    const activeCard = document.querySelector(".product-card.active");

    // 활성화된 카드가 있고, 클릭한 요소가 카드나 카드 내부 요소가 아닌 경우
    if (
      activeCard &&
      !event.target.closest(".product-card") &&
      !event.target.classList.contains("apply-class-btn")
    ) {
      // 모바일 환경인지 확인 (768px 이하)
      if (window.innerWidth <= 768) {
        // 모든 카드 초기화
        resetAllCards();
      }
    }
  });

  // 전역변수의 계획 데이터 사용
  function loadPlanData() {
    console.log("loadPlanData 함수 호출됨");

    // 디버깅: 전역 데이터 확인
    console.log("[DEBUG] window.totalData 확인:", window.totalData);
    if (window.totalData) {
      console.log(
        "[DEBUG] memberData 길이:",
        window.totalData.memberData
          ? window.totalData.memberData.length
          : "없음"
      );
      console.log(
        "[DEBUG] classData 길이:",
        window.totalData.classData ? window.totalData.classData.length : "없음"
      );
      console.log(
        "[DEBUG] planData 길이:",
        window.totalData.planData ? window.totalData.planData.length : "없음"
      );

      // planData 첫 번째 항목 확인 (있는 경우)
      if (window.totalData.planData && window.totalData.planData.length > 0) {
        console.log(
          "[DEBUG] planData 첫 번째 항목 샘플:",
          window.totalData.planData[0]
        );
      }
    }

    // 선택된 날짜 가져오기
    const dateInput = document.getElementById("date-input");
    let selectedDateStr = "";

    if (dateInput && dateInput.value) {
      // yyyy-mm-dd 형식을 yyyymmdd 형식으로 변환
      selectedDateStr = dateInput.value.replace(/-/g, "");
      console.log("선택된 날짜로 데이터 로드:", selectedDateStr);
    } else {
      // 날짜 입력이 없으면 오늘 날짜 사용
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, "0");
      const day = String(today.getDate()).padStart(2, "0");
      selectedDateStr = `${year}${month}${day}`;
      console.log("오늘 날짜로 데이터 로드:", selectedDateStr);
    }

    showLoading(true);

    try {
      // planData가 없거나 빈 배열인 경우 바로 처리
      if (
        !window.totalData ||
        !window.totalData.planData ||
        window.totalData.planData.length === 0
      ) {
        console.warn("계획 데이터가 없음: 빈 배열 또는 정의되지 않음");

        // 데이터 없음 처리
        handleNoPlanData();
        return;
      }

      // 전역변수 totalData에서 planData 사용
      console.log(
        "전역변수 totalData.planData 사용:",
        window.totalData.planData.length + "개 항목"
      );
      const result = window.totalData.planData;
      processPlanData(result);
    } catch (error) {
      console.error("계획 데이터 처리 중 오류 발생:", error);
      showErrorMessage("활동 계획 데이터를 처리하는 중 오류가 발생했습니다.");
    }

    // 데이터가 없을 때 처리하는 함수
    function handleNoPlanData() {
      console.warn("handleNoPlanData 함수 호출됨");

      // 로딩 중단
      showLoading(false);

      // 메시지 표시
      const message = document.createElement("div");
      message.className = "success-message";
      message.style.backgroundColor = "#ff9800"; // 주황색 경고 메시지
      message.textContent = "해당 날짜에 등록된 활동이 없습니다.";
      document.body.appendChild(message);

      // 메시지 표시 및 페이지 전환
      setTimeout(() => {
        message.classList.add("show");

        setTimeout(() => {
          message.classList.remove("show");

          setTimeout(() => {
            document.body.removeChild(message);

            // 페이지 전환 효과 적용
            const pageEl = document.querySelector(".class-select-page");
            if (pageEl) {
              pageEl.classList.add("p1-fade-out");
            }

            // 회원 선택 페이지로 이동
            setTimeout(() => {
              loadPage("member-select");
            }, 200);
          }, 200);
        }, 2000);
      }, 10);
    }

    // 데이터 처리 및 표시 함수
    function processPlanData(result) {
      // 결과가 비어있는 경우 확인
      if (!result || result.length === 0) {
        console.warn("해당 날짜에 계획 데이터가 없음");

        // 로딩 중단
        showLoading(false);

        // 메시지 표시
        const message = document.createElement("div");
        message.className = "success-message";
        message.style.backgroundColor = "#ff9800"; // 주황색 경고 메시지
        message.textContent = "해당 날짜에 등록된 활동이 없습니다.";
        document.body.appendChild(message);

        // 메시지 표시 및 페이지 전환
        setTimeout(() => {
          message.classList.add("show");

          setTimeout(() => {
            message.classList.remove("show");

            setTimeout(() => {
              document.body.removeChild(message);

              // 페이지 전환 효과 적용
              document
                .querySelector(".class-select-page")
                .classList.add("p1-fade-out");

              // 회원 선택 페이지로 이동
              setTimeout(() => {
                loadPage("member-select");
              }, 200);
            }, 200);
          }, 2000);
        }, 10);

        return;
      }

      // 실제 데이터로부터 시간 정보 업데이트
      const wasUpdated = CLASS_TIMES.updateFromData(result);
      if (wasUpdated) {
        console.log("시간 정보가 실제 데이터로 업데이트됨");
        console.log("업데이트된 시간 정보:", {
          START: CLASS_TIMES.START,
          END: CLASS_TIMES.END,
          LABELS: CLASS_TIMES.LABELS,
          TITLES: CLASS_TIMES.TITLES,
        });
      } else {
        console.log("기본 시간 정보 사용");
        // 기본 타이틀 업데이트
        CLASS_TIMES.updateTitles();
      }

      // 차수별로 클래스 분류
      const classesByTime = {
        first: [],
        second: [],
        third: [],
        fourth: [],
        fifth: [],
      };

      // 객체 데이터 매핑
      result.forEach((row) => {
        const startTime = String(row.시작시간); // 시작 시간
        if (startTime) {
          // 시작 시간으로 차수 결정
          const classIndex = CLASS_TIMES.getClassIndex(startTime);

          if (classIndex >= 0) {
            // 차수 레이블 가져오기 (1차, 2차 등)
            const classType = CLASS_TIMES.LABELS[classIndex];

            // 시간대별 배열에 추가
            switch (classType) {
              case "1차":
                classesByTime.first.push(row);
                break;
              case "2차":
                classesByTime.second.push(row);
                break;
              case "3차":
                classesByTime.third.push(row);
                break;
              case "4차":
                classesByTime.fourth.push(row);
                break;
              case "5차":
                classesByTime.fifth.push(row);
                break;
            }
          }
        }
      });

      // 컨테이너 초기화
      const container = document.getElementById("products-container");
      if (container) {
        container.innerHTML = "";
      }

      // 각 차수별로 표시
      displayTimeSection(CLASS_TIMES.TITLES[0], classesByTime.first);
      displayTimeSection(CLASS_TIMES.TITLES[1], classesByTime.second);
      displayTimeSection(CLASS_TIMES.TITLES[2], classesByTime.third);
      displayTimeSection(CLASS_TIMES.TITLES[3], classesByTime.fourth);
      displayTimeSection(CLASS_TIMES.TITLES[4], classesByTime.fifth);

      // 모든 카드가 로드된 후 컨테이너 표시
      setTimeout(() => {
        if (container) {
          container.classList.add("show");
        }
      }, 100);

      showLoading(false);
    }

    // 오류 메시지 표시 함수
    function showErrorMessage(message) {
      const container = document.getElementById("products-container");
      if (container) {
        container.innerHTML = `<div class="error-message">${message}</div>`;
      }

      showLoading(false);
    }
  }

  // 확인 모달 열기
  function openConfirmModal(card) {
    // 카드에서 데이터 추출
    const id = card.getAttribute("data-id");
    const title = card.getAttribute("data-title");
    const startTime = card.getAttribute("data-start");
    const endTime = card.getAttribute("data-end");
    const instructor = card.getAttribute("data-instructor");
    const employeeNumber = card.getAttribute("data-employee-number") || ""; // 직원번호 추가
    const lifeArea = card.getAttribute("data-life-area");
    const location = card.getAttribute("data-location");

    // 시간 포맷팅
    const formattedStartTime = CLASS_TIMES.formatTime(startTime);
    const formattedEndTime = CLASS_TIMES.formatTime(endTime);

    // 활동 정보 저장 (신청 처리에 사용)
    selectedActivity = {
      id: id,
      title: title,
      startTime: startTime,
      endTime: endTime,
      instructor: instructor,
      employeeNumber: employeeNumber, // 직원번호 추가
      lifeArea: lifeArea,
      location: location,
    };

    // 시간대 차수 확인
    const classType = CLASS_TIMES.getLabelByTime(startTime);

    // 모달 내용 업데이트
    document.getElementById("confirm-activity-name").textContent = title;
    document.getElementById(
      "confirm-time"
    ).textContent = `${formattedStartTime} ~ ${formattedEndTime}`;
    document.getElementById("confirm-instructor").textContent = instructor;

    // 회원 정보 업데이트
    if (selectedMember) {
      document.getElementById("confirm-member-name").textContent =
        selectedMember.name;
    }

    // 모달 열기
    const modal = document.getElementById("confirm-modal");
    if (modal) modal.classList.add("active");
  }

  // 모달 닫기
  function closeModal() {
    const modal = document.getElementById("confirm-modal");
    if (modal) {
      modal.classList.remove("active");

      // 모달을 닫은 후 선택된 활동 정보 초기화
      selectedActivity = null;
    }
  }

  // 활동 신청 처리
  function applyActivity() {
    console.log("applyActivity 함수 호출됨");
    if (!selectedActivity) {
      alert("선택된 활동이 없습니다.");
      return;
    }

    // 날짜 값 가져오기
    const datePicker = document.getElementById("date-input");
    const activityDate = datePicker?.value
      ? datePicker.value.replace(/-/g, "")
      : getCurrentDateString().replace(/-/g, "");

    // 신청 데이터 준비
    const applicationData = {
      activityId: selectedActivity.id, // 활동 ID
      activityDate: activityDate, // 날짜(yyyymmdd형식)
      classType: CLASS_TIMES.getLabelByTime(selectedActivity.startTime), // 차수
      startTime: selectedActivity.startTime, // 시작시간
      endTime: selectedActivity.endTime, // 종료시간
      instructor: selectedActivity.instructor, // 직원명
      employeeNumber: selectedActivity.employeeNumber, // 직원번호
      title: selectedActivity.title, // 활동명
      lifeArea: selectedActivity.lifeArea, // 생활영역
      memberNumber: selectedMember.number, // 회원번호
      memberName: selectedMember.name, // 회원명
      memberBirth: selectedMember.birth, // 생년월일
    };

    console.log("신청 데이터:", applicationData);

    // 샘플 환경 - 테스트 동작
    console.log("테스트 환경: 가상 신청 처리");
    addAppliedClass(applicationData);
    showSuccessMessage();
    closeModal();

    // 다음 빈 클래스로 이동
    moveToNextEmptyClass(selectedActivity);
  }

  // 현재 날짜를 YYYY-MM-DD 형식으로 반환
  function getCurrentDateString() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, "0");
    const day = String(today.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  }

  // 신청한 클래스 추가 - 완전한 신청 데이터 저장
  function addAppliedClass(applicationData) {
    // 같은 ID의 클래스가 있는지 확인
    const existingByIdIndex = appliedClasses.findIndex(
      (item) => item.activityId === applicationData.activityId
    );

    // 이미 같은 ID가 있으면 제거 (업데이트)
    if (existingByIdIndex >= 0) {
      appliedClasses.splice(existingByIdIndex, 1);
    } else {
      // 같은 차수의 다른 클래스가 있는지 확인
      const classType = applicationData.classType;

      // 같은 차수에 이미 클래스가 있는지 확인
      if (classType !== "기타") {
        const existingByTimeIndex = appliedClasses.findIndex(
          (item) => item.classType === classType
        );

        // 같은 차수에 기존 클래스가 있으면 제거하고 메시지 표시
        if (existingByTimeIndex >= 0) {
          const removedClass = appliedClasses[existingByTimeIndex];
          appliedClasses.splice(existingByTimeIndex, 1);

          // 사용자에게 알림 표시
          const warningMessage = document.createElement("div");
          warningMessage.className = "success-message";
          warningMessage.style.backgroundColor = "#ff9800";
          warningMessage.textContent = `${classType} 시간대의 기존 신청 (${removedClass.title})이 취소되었습니다.`;
          document.body.appendChild(warningMessage);

          // 메시지 표시 및 제거
          setTimeout(() => {
            warningMessage.classList.add("show");

            setTimeout(() => {
              warningMessage.classList.remove("show");

              setTimeout(() => {
                document.body.removeChild(warningMessage);
              }, 300);
            }, 3000);
          }, 10);
        }
      }
    }

    // 새로 추가 (완전한 applicationData 저장)
    appliedClasses.push(applicationData);

    // 시작 시간순으로 정렬
    appliedClasses.sort((a, b) =>
      String(a.startTime).localeCompare(String(b.startTime))
    );

    // 저장 및 표시 업데이트
    displayAppliedClasses();
  }

  // 성공 메시지 표시
  function showSuccessMessage() {
    const message = document.getElementById("success-message");
    message.classList.add("show");

    // 3초 후 메시지 숨기기
    setTimeout(() => {
      message.classList.remove("show");
    }, 3000);
  }

  // 회원 변경
  function changeMember() {
    // 페이드 아웃 효과 적용 후 페이지 이동
    document.querySelector(".class-select-page").classList.add("p1-fade-out");
    setTimeout(() => {
      // 회원 선택 페이지로 이동
      loadPage("member-select");
    }, 400);
  }

  // 모든 신청 초기화 처리
  function resetAllClasses() {
    console.log("모든 클래스 초기화 함수 호출");

    // 신청 데이터가 없으면 무시
    if (!appliedClasses || appliedClasses.length === 0 || !selectedMember) {
      console.log("초기화할 신청 데이터가 없음");

      // 신청 데이터가 없어도 회원 선택 페이지로 이동
      moveToMemberSelect();
      return;
    }

    // 확인 메시지 없이 바로 진행
    console.log("신청 취소 진행");

    // 로딩 표시
    showLoading(true);

    // 날짜 정보 가져오기
    const dateInput = document.getElementById("date-input");
    const activityDate = dateInput?.value
      ? dateInput.value.replace(/-/g, "")
      : formatDate(new Date()).replace(/-/g, "");

    // Supabase 함수 호출하여 해당 회원의 모든 클래스 취소
    cancelAllClasses(selectedMember.number, activityDate)
      .then((response) => {
        console.log("취소 응답:", response);

        if (response.success) {
          // 신청한 클래스 배열 초기화
          appliedClasses = [];
          window.updateState("appliedClasses", []);

          // 화면에서 신청 클래스 태그 업데이트
          displayAppliedClasses();

          // 성공 메시지 표시 (선택 사항 - 필요없으면 제거 가능)
          const message = document.createElement("div");
          message.className = "success-message";
          message.textContent = `${selectedMember.name} 회원님의 모든 신청이 취소되었습니다.`;
          document.body.appendChild(message);

          setTimeout(() => {
            message.classList.add("show");

            setTimeout(() => {
              message.classList.remove("show");

              setTimeout(() => {
                document.body.removeChild(message);

                // 회원 선택 페이지로 이동
                moveToMemberSelect();
              }, 200);
            }, 1000);
          }, 10);
        } else {
          // 오류 메시지 표시
          alert(`신청 취소 중 오류 발생: ${response.message}`);
          // 오류가 있어도 회원 선택 페이지로 이동
          moveToMemberSelect();
        }

        // 로딩 숨김
        showLoading(false);
      })
      .catch((error) => {
        console.error("취소 오류:", error);

        // 오류 메시지 표시
        alert(`신청 취소 중 오류 발생: ${error.message || error}`);

        // 로딩 숨김
        showLoading(false);

        // 오류가 있어도 회원 선택 페이지로 이동
        moveToMemberSelect();
      });
  }

  // 회원 선택 페이지로 이동하는 함수
  function moveToMemberSelect() {
    // 페이지 전환 효과 적용
    const pageEl = document.querySelector(".class-select-page");
    if (pageEl) {
      pageEl.classList.add("p1-fade-out");

      // 회원 선택 페이지로 이동
      setTimeout(() => {
        loadPage("member-select");
      }, 400);
    } else {
      // 페이지 요소가 없으면 바로 이동
      loadPage("member-select");
    }
  }

  // 로딩 표시/숨김 기능
  function showLoading(isShow) {
    const loadingElement = document.getElementById("loading");
    if (loadingElement) {
      loadingElement.style.display = isShow ? "flex" : "none";
    }
  }

  // 필터 버튼 설정
  function setupFilterButtons() {
    const filterButtons = document.querySelectorAll(".filter-button");
    const productsContainer = document.getElementById("products-container");

    // 페이지 로드 시 '1차 클래스' 탭이 기본으로 활성화되도록 설정
    const class1Button = document.querySelector('.filter-button[data-filter="class1"]');
    if (class1Button) {
      // 모든 버튼에서 활성 클래스 제거
      filterButtons.forEach((btn) => btn.classList.remove("active"));
      
      // 1차 클래스 버튼 활성화
      class1Button.classList.add("active");
      
      // products-container에서 all-visible 클래스 제거
      productsContainer.classList.remove("all-visible");
      
      // 모든 섹션 숨기기
      document.querySelectorAll(".time-section").forEach((section) => {
        section.classList.remove("visible");
      });
      
      // 1차 섹션만 보이기
      const selectedSection = document.getElementById("class1-section");
      if (selectedSection) {
        selectedSection.classList.add("visible");
      }
    }

    filterButtons.forEach((button) => {
      button.addEventListener("click", function () {
        // 모든 버튼에서 활성 클래스 제거
        filterButtons.forEach((btn) => btn.classList.remove("active"));

        // 현재 버튼에 활성 클래스 추가
        this.classList.add("active");

        // 필터 값 가져오기
        const filter = this.getAttribute("data-filter");

        // 필터에 따라 섹션 표시/숨김 처리
        if (filter === "all") {
          // 전체 보기
          productsContainer.classList.add("all-visible");
        } else {
          // 특정 차수만 보기
          productsContainer.classList.remove("all-visible");

          // 모든 섹션 숨기기
          document.querySelectorAll(".time-section").forEach((section) => {
            section.classList.remove("visible");
          });

          // 선택된 섹션만 보이기
          const selectedSection = document.getElementById(`${filter}-section`);
          if (selectedSection) {
            selectedSection.classList.add("visible");
          }
        }
      });
    });
  }

  // 다음 빈 클래스로 이동 (수정)
  function moveToNextEmptyClass(currentActivity) {
    console.log("moveToNextEmptyClass 함수 호출됨", currentActivity);

    // 먼저 모든 카드의 비활성화 상태 해제
    resetAllCards();

    // 페이지 상단으로 스크롤
    window.scrollTo({ top: 0, behavior: "smooth" });

    // 미신청 클래스 여부 확인 (유효한 차수만)
    const availableClasses = checkAvailableClasses();
    console.log("사용 가능한 클래스:", availableClasses);

    // 미신청 클래스가 없으면 완료 모달 표시
    if (availableClasses.length === 0) {
      console.log("모든 클래스 신청 완료, 모달 표시");
      openCompleteModal();
      return;
    }

    // currentActivity가 null이거나 정의되지 않은 경우 처리
    if (!currentActivity || !currentActivity.startTime) {
      if (availableClasses.length > 0) {
        // 첫 번째 사용 가능한 클래스로 스크롤
        setTimeout(() => {
          scrollToClass(availableClasses[0]);
          clickFilterButton(availableClasses[0]);
        }, 300);
      }
      return;
    }

    // 현재 활동의 시간대 찾기
    const currentClass = CLASS_TIMES.getLabelByTime(currentActivity.startTime);

    // 차수를 알 수 없으면 첫 번째 사용 가능한 클래스로 이동
    if (currentClass === "기타") {
      if (availableClasses.length > 0) {
        setTimeout(() => {
          scrollToClass(availableClasses[0]);
          clickFilterButton(availableClasses[0]);
        }, 300);
      }
      return;
    }

    // 현재 차수 이후의 첫 번째 빈 클래스 찾기
    let nextEmptyClass = findNextEmptyClass(currentClass);

    if (nextEmptyClass) {
      // 다음 빈 클래스가 있으면 해당 클래스로 스크롤 (지연 적용)
      setTimeout(() => {
        scrollToClass(nextEmptyClass);
        // 해당 클래스 섹션 표시하기 위해 필터 버튼 클릭
        clickFilterButton(nextEmptyClass);
      }, 300);
    } else {
      // 다음 빈 클래스가 없으면 첫 번째 사용 가능한 클래스로 이동
      if (availableClasses.length > 0) {
        setTimeout(() => {
          scrollToClass(availableClasses[0]);
          clickFilterButton(availableClasses[0]);
        }, 300);
      } else {
        // 모든 유효한 클래스를 신청했으면 완료 모달 표시
        openCompleteModal();
      }
    }
  }

  // 특정 클래스로 스크롤
  function scrollToClass(classType) {
    const sectionId = `class${classType.charAt(0)}-section`;
    const section = document.getElementById(sectionId);

    if (section) {
      section.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  }

  // 모든 카드의 비활성화 상태 해제
  function resetAllCards() {
    // 활성화된 카드 찾기
    const activeCard = document.querySelector(".product-card.active");
    if (activeCard) {
      activeCard.classList.remove("active");
    }

    // 비활성화된 카드 모두 활성화
    document.querySelectorAll(".product-card.inactive").forEach((card) => {
      card.classList.remove("inactive");
    });

    // 오버레이 제거
    const overlay = document.querySelector(".card-overlay");
    if (overlay) {
      overlay.classList.remove("active");
    }
  }

  // 다음 빈 클래스 찾기
  function findNextEmptyClass(currentClass) {
    // 클래스 순서 정의
    const classOrder = ["1차", "2차", "3차", "4차", "5차"];
    const currentIndex = classOrder.indexOf(currentClass);

    // 이미 신청한 클래스의 차수들 목록
    const appliedClassTypes = [];
    appliedClasses.forEach((classItem) => {
      const startTime = parseInt(classItem.startTime);
      if (startTime >= 900 && startTime < 1030) {
        appliedClassTypes.push("1차");
      } else if (startTime >= 1030 && startTime < 1200) {
        appliedClassTypes.push("2차");
      } else if (startTime >= 1300 && startTime < 1430) {
        appliedClassTypes.push("3차");
      } else if (startTime >= 1430 && startTime < 1600) {
        appliedClassTypes.push("4차");
      } else if (startTime >= 1600 && startTime < 1730) {
        appliedClassTypes.push("5차");
      }
    });

    // 현재 클래스 다음부터 순서대로 확인
    for (let i = currentIndex + 1; i < classOrder.length; i++) {
      // 해당 차수를 아직 신청하지 않았으면 반환
      if (!appliedClassTypes.includes(classOrder[i])) {
        return classOrder[i];
      }
    }

    // 다음 클래스가 없으면 현재 클래스 이전의 클래스들 확인
    for (let i = 0; i < currentIndex; i++) {
      if (!appliedClassTypes.includes(classOrder[i])) {
        return classOrder[i];
      }
    }

    // 모든 클래스를 이미 신청했으면 null 반환
    return null;
  }

  // 필터 버튼 클릭 (프로그래밍적으로)
  function clickFilterButton(classType) {
    const filterButton = document.querySelector(
      `.filter-button[data-filter="class${classType.charAt(0)}"]`
    );

    if (filterButton) {
      filterButton.click();
    }
  }

  // 모든 클래스 완료 확인 모달 닫기
  function closeCompleteModal() {
    const modal = document.getElementById("complete-modal-overlay");
    if (modal) {
      modal.classList.remove("show");
    }
  }

  // 모든 신청 완료 처리
  function finalizeAllApplications() {
    console.log("finalizeAllApplications 함수 호출됨");

    // 신청한 클래스가 없으면 처리하지 않음
    if (!appliedClasses || appliedClasses.length === 0) {
      alert("신청한 클래스가 없습니다.");
      closeCompleteModal();
      return;
    }

    // 먼저 모달 닫기
    closeCompleteModal();

    // 그 다음 로딩 표시
    setTimeout(() => {
      showLoading(true);

      // 디버깅: 테이블 구조 확인 (테이블 구조 확인 함수가 있다면 호출)
      if (typeof checkColumns === "function") {
        console.log("테이블 구조 확인 함수 호출");
        checkColumns()
          .then(() => {
            console.log("테이블 구조 확인 완료, 데이터 저장 진행");
            saveData();
          })
          .catch((error) => {
            console.error("테이블 구조 확인 중 오류:", error);
            saveData(); // 오류가 있더라도 데이터 저장 시도
          });
      } else {
        // 테이블 구조 확인 함수가 없으면 바로 데이터 저장
        saveData();
      }

      // 실제 데이터 저장 함수
      function saveData() {
        // 수업신청_id 생성 (회원번호-yyyymmddhhmmssSSS)
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        const seconds = String(now.getSeconds()).padStart(2, "0");
        const milliseconds = String(now.getMilliseconds()).padStart(3, "0");

        const timeStamp = `${year}${month}${day}${hours}${minutes}${seconds}${milliseconds}`;
        const applicationId = `class-${selectedMember.number}-${timeStamp}`;

        console.log("생성된 수업신청_id:", applicationId);

        // 수파베이스에 저장할 데이터 준비
        const rowsData = appliedClasses.map((classItem) => {
          // 날짜 확인 및 포맷팅 (YYYY-MM-DD → YYYYMMDD)
          let activityDate = classItem.activityDate;
          if (activityDate && activityDate.includes("-")) {
            activityDate = activityDate.replace(/-/g, "");
          }

          // 생년월일 포맷팅 (이미 YYYYMMDD 형식이면 그대로 사용)
          let memberBirth = classItem.memberBirth;
          if (memberBirth && String(memberBirth).includes("-")) {
            memberBirth = String(memberBirth).replace(/-/g, "");
          }

          // 행 데이터 구성
          // (수업신청_id, 계획_id, 날짜, 차수, 시작시간, 종료시간, 직원번호, 직원명, 활동명, 생활영역, 회원번호, 회원명, 생년월일)
          return [
            applicationId, // 수업신청_id
            classItem.activityId, // 계획_id
            activityDate, // 날짜
            classItem.classType, // 차수
            classItem.startTime, // 시작시간
            classItem.endTime, // 종료시간
            classItem.employeeNumber, // 직원번호
            classItem.instructor, // 직원명
            classItem.title, // 활동명
            classItem.lifeArea, // 생활영역
            classItem.memberNumber, // 회원번호
            classItem.memberName, // 회원명
            memberBirth, // 생년월일
          ];
        });

        console.log("수파베이스에 저장할 데이터:", rowsData);

        // Supabase로 데이터 전송
        appendClassrow(rowsData)
          .then((response) => {
            console.log("신청 데이터 저장 성공:", response);

            // 신청 데이터 즉시 초기화
            appliedClasses = [];
            window.updateState("appliedClasses", []);

            // 로딩 숨김
            showLoading(false);

            // 성공 메시지 표시 (짧은 시간만 표시)
            const message = document.createElement("div");
            message.className = "success-message";
            message.textContent = "모든 활동 신청이 완료되었습니다!";
            document.body.appendChild(message);

            // 메시지 표시와 페이지 전환을 거의 동시에 진행
            setTimeout(() => {
              message.classList.add("show");
              
              // 페이지 전환 효과 즉시 적용
              document.querySelector(".class-select-page").classList.add("p1-fade-out");
              
              // 매우 짧은 시간 후 페이지 전환 및 메시지 제거
              setTimeout(() => {
                loadPage("member-select");
                
                // 메시지 제거는 페이지 전환 후에 처리
                setTimeout(() => {
                  message.classList.remove("show");
                  document.body.removeChild(message);
                }, 300);
              }, 50); // 50ms 후 페이지 전환 (사용자가 성공 메시지를 볼 수 있는 최소 시간)
            }, 10);
          })
          .catch((error) => {
            console.error("신청 데이터 저장 실패:", error);
            showLoading(false);

            // 오류 메시지 표시
            alert("활동 신청 데이터 저장에 실패했습니다: " + error);
          });
      }
    }, 50); // 모달이 완전히 닫힌 후 로딩 표시
  }

  // 모달 버튼 설정
  function setupModalButtons() {
    const submitBtn = document.getElementById("complete-modal-btn-primary");
    if (submitBtn) {
      submitBtn.addEventListener("click", finalizeAllApplications);
    }

    // 카드의 신청 버튼 이벤트 리스너 추가
    document.addEventListener("click", function (event) {
      // 이벤트 위임으로 신청 버튼 클릭 처리
      if (event.target.classList.contains("apply-class-btn")) {
        event.stopPropagation(); // 버블링 방지
        const card = event.target.closest(".product-card");
        if (card) {
          openConfirmModal(card);
        }
      }
    });
  }

  // 모든 클래스 완료 확인 모달 열기
  function openCompleteModal() {
    console.log("openCompleteModal 함수 호출됨");

    // 신청한 클래스가 없으면 모달을 표시하지 않음
    if (!appliedClasses || appliedClasses.length === 0) {
      console.log("신청한 클래스가 없어 모달을 표시하지 않음");
      return;
    }

    // 컨테이너 가져오기
    const listContainer = document.getElementById("complete-classes-list");
    if (!listContainer) {
      console.error("complete-classes-list 요소를 찾을 수 없습니다.");
      return;
    }

    // 리스트 비우기
    listContainer.innerHTML = "";

    // 신청한 클래스 정렬 (차수 순)
    const sortedClasses = [...appliedClasses].sort((a, b) => {
      const startTimeA = parseInt(a.startTime);
      const startTimeB = parseInt(b.startTime);
      return startTimeA - startTimeB;
    });

    // 신청한 클래스 추가
    sortedClasses.forEach((classItem, index) => {
      // 차수 결정
      const classType = CLASS_TIMES.getLabelByTime(classItem.startTime);

      // 시간 포맷팅
      const formattedStartTime = CLASS_TIMES.formatTime(classItem.startTime);
      const formattedEndTime = CLASS_TIMES.formatTime(classItem.endTime);
      const formattedTime = `${formattedStartTime} ~ ${formattedEndTime}`;

      // 항목 HTML 생성
      const itemHTML = `
                        <div id="complete-item-${index}" class="complete-class-item">
                            <div id="class-badge-${index}" class="complete-class-badge">${classType}</div>
                            <div class="complete-class-content">
                                <div id="class-title-${index}" class="complete-class-title">${
        classItem.title
      }</div>
                                <div id="class-details-${index}" class="complete-class-instructor">
                                    ${formattedTime} | 담당: ${
        classItem.instructor
      } | 장소: ${classItem.location || "정보 없음"}
                                </div>
                            </div>
                        </div>
                    `;

      // 목록에 추가
      listContainer.insertAdjacentHTML("beforeend", itemHTML);
    });

    // 메시지 업데이트
    const messageElement = document.getElementById("complete-modal-message");
    if (messageElement && selectedMember) {
      messageElement.textContent = `${selectedMember.name} 회원님이 ${sortedClasses.length}개의 활동에 신청하셨습니다. 신청을 완료하시겠습니까?`;
    }

    // 모달 표시
    const modalElement = document.getElementById("complete-modal-overlay");
    if (modalElement) {
      modalElement.classList.add("show");
      console.log("완료 모달이 표시되었습니다.");
    } else {
      console.error("complete-modal-overlay 요소를 찾을 수 없습니다.");
    }
  }

  // 미신청 클래스 확인 (유효한 차수만 계산)
  function checkAvailableClasses() {
    // 클래스 순서 정의
    const classOrder = ["1차", "2차", "3차", "4차", "5차"];

    // 이미 신청한 클래스의 차수들 목록
    const appliedClassTypes = [];
    appliedClasses.forEach((classItem) => {
      const classType = CLASS_TIMES.getLabelByTime(classItem.startTime);
      if (classType !== "기타") {
        appliedClassTypes.push(classType);
      }
    });

    console.log("신청한 클래스 차수:", appliedClassTypes);

    // 각 차수에 표시할 수 있는 카드가 있는지 확인
    const availableClassTypes = [];
    classOrder.forEach((classType) => {
      // 해당 차수를 아직 신청하지 않았고, 실제 카드가 있는지 확인
      if (!appliedClassTypes.includes(classType)) {
        const sectionId = `class${classType.charAt(0)}-section`;
        const section = document.getElementById(sectionId);

        if (section) {
          // 섹션 내에 표시 가능한 카드가 있는지 확인
          const cards = section.querySelectorAll(
            ".product-card:not(.inactive)"
          );
          if (cards.length > 0) {
            availableClassTypes.push(classType);
          }
        }
      }
    });

    console.log("신청 가능한 클래스 차수:", availableClassTypes);
    return availableClassTypes;
  }

  // ESC 키 이벤트 리스너 추가
  document.addEventListener("keydown", function (event) {
    // ESC 키 (keyCode 27)가 눌렸을 때
    if (event.key === "Escape" || event.keyCode === 27) {
      // 활성화된 카드가 있는지 확인
      const activeCard = document.querySelector(".product-card.active");
      if (activeCard) {
        // 카드 초기화 함수 호출
        resetAllCards();
      }
    }
  });
</script>
